\documentclass{article}
\usepackage{amsmath, amsthm, amssymb, booktabs, hyperref, graphicx, float, esint, xcolor}
\setlength{\abovedisplayskip}{0pt}
\setlength{\belowdisplayskip}{0pt}
\setlength{\abovedisplayshortskip}{0pt}
\setlength{\belowdisplayshortskip}{0pt}

\newcommand{\vr}{\vec{r}}
\newcommand{\vOmega}{\vec{\Omega}}
\newcommand{\vO}{\vec{\Omega}}
\newcommand{\bra}{\left\langle}
\newcommand{\ket}{\right\rangle}
\newcommand{\vdiv}{\vec{\nabla} \cdot}
\newcommand{\vgrad}{\vec{\nabla}}
\newcommand{\vbeta}{\vec{\beta} }
\newcommand{\pdx}{\frac{\partial}{\partial x}}
\newcommand{\pdy}{\frac{\partial}{\partial y}}
\newcommand{\pdz}{\frac{\partial}{\partial z}}
\newcommand{\intrrr}{\int d^3 r \,}
\newcommand{\intrr}{\int d^2 r \,}

\begin{document}
\begin{center}
Ian Halvic \\
\end{center}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{1D-Sn Transport (Clean up for 1/2 in source)}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Define our forward Sn transport equation
\[
\vO \cdot \vgrad \psi + \sigma_t \psi = \frac{\sigma_s}{4 \pi} \phi + \frac{q}{4 \pi} \quad \vr \in V
\]
with BC 
\[
\psi(\vr,\vO) = \psi^{\text{inc}}(\vr,\vO) \quad \vr \in \partial V^-
\]
with $\partial V^{\mp}=\left\{ \partial V \text{ such that } \vr \cdot \vO \lessgtr 0 \right\}$.

The adjoint Sn transport equation
\[
- \vO \cdot \vgrad \psi^\dag + \sigma_t \psi^\dag = \frac{\sigma_s}{4 \pi} \phi^\dag + q^\dag
\]
Where the adjoint source is our response $q^\dag = \frac{r}{4 \pi}$
\textcolor{red}{always give bc as well}
Multiply the forward by $\psi^\dag$ and integrate over space and angle
\[
\int d^3 r \, \int d  \Omega \,  \psi^\dag \left[ \vO \cdot \vgrad \psi + \sigma_t \psi  \right] = 
\int d^3 r \, \int d  \Omega \,  \psi^\dag \left[ \frac{\sigma_s}{4 \pi} \phi + \frac{q}{4 \pi}  \right]
\]
Take a look at the RHS first
\begin{align*}
\int d^3 r \, \int d  \Omega \,  \psi^\dag \left[ \frac{\sigma_s}{4 \pi} \phi + \frac{q}{4 \pi}  \right]
&= 
\int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{\sigma_s}{4 \pi} \phi + \int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{q}{4 \pi}  \\
&= 
\int d^3 r \, \frac{\sigma_s}{4 \pi} \phi \int d  \Omega \,  \psi^\dag  + \int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{q}{4 \pi}  \\
&= 
\int d^3 r \, \frac{\sigma_s}{4 \pi} \phi  \phi^\dag  + \int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{q}{4 \pi}  \\
&= 
\int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{\sigma_s}{4 \pi} \phi^\dag + \int d^3 r \, \int d  \Omega \,  \psi^\dag \frac{q}{4 \pi}  \\
\end{align*}
On the LHS, take a look at the first integral
\begin{align*}
\int d^3 r \, \int d  \Omega \,  \psi^\dag \left[  \vO \cdot \vgrad \psi \right]
&= \int d^3 r \, \int d  \Omega \,  \psi^\dag \left[  \vdiv (\vO \psi) \right] \\
&= - \int d^3 r \, \int d  \Omega \,  \vgrad \psi^\dag \cdot \left[(\vO \psi) \right] 
+ \int d^2 r \, \int d  \Omega \, \psi^\dag \vO \psi \cdot \vec{n} \\
&= - \int d^3 r \, \int d  \Omega \,  \psi \left[  \vO \cdot \vgrad \psi^\dag \right] 
+ \int d^2 r \, \int d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n})
\end{align*}
Expressed as the in inner product notation of $\int d^3 r \, \int d  \Omega $ the above states
\begin{align*}
\bra \psi^\dag , q \ket &=  \bra \psi^\dag , \vO \cdot \vgrad \psi + \sigma_t \psi - \frac{\sigma_s}{4 \pi} \phi \ket \\
&=  \bra - \vO \cdot \vgrad \psi^\dag + \sigma_t \psi^\dag - \frac{\sigma_s}{4 \pi} \phi^\dag , \psi \ket + \int d^2 r \, \int d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n} ) \\
&=  \bra q^\dag , \psi \ket + \int d^2 r \, \int d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n} ) \\
\end{align*}
Our QoI is defined as 
\[
J=\bra q^\dag , \psi \ket
\]
So, using the adjoint manipulation from above
\[
J = \bra \psi^\dag , q \ket - \int d^2 r \, \int d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n} )
\]
The surface interval can be split into incoming and outgoing 
\[
J = \bra \psi^\dag , q \ket - \int d^2 r \, \int_{\vO \cdot \vec{n} >0} d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n} ) - \int d^2 r \, \int_{\vO \cdot \vec{n} <0} d  \Omega \, \psi^\dag \psi ( \vO \cdot \vec{n} )
\]
Where we would expect to specify the incoming flux for the forward and the outgoing flux for the adjoint.
\section{1D-Sn Transport Sensitivity}
Now assume we perturb our forward transport equation.
Define our forward Sn transport equation
\[
\vO \cdot \vgrad \left( \psi + \delta \psi \right) + \left( \sigma_t + \delta \sigma_t \right) \left( \psi + \delta \psi \right) = \frac{\left( \sigma_s + \delta \sigma_s \right)}{4 \pi} \left( \phi + \delta \phi \right) + \left( q + \delta q \right)
\]
Retain the adjoint equation
\[
- \vO \cdot \vgrad \psi^\dag + \sigma_t \psi^\dag = \frac{\sigma_s}{4 \pi} \phi^\dag + q^\dag
\]
Expand and drop the second order terms [What does this mean for BC?]. Define the quantity $\psi_p = \psi + \delta \psi$ and $\phi_p = \phi + \delta \phi$
\begin{align*}
\vO \cdot \vgrad  \psi_p + \ \sigma_t \psi_p + \delta \sigma_t \psi = \frac{ \sigma_s }{4 \pi}  \phi_p + \frac{ \delta \sigma_s }{4 \pi}  \phi  + q + \delta q 
\end{align*}
Rearrange to the suggestive form
\[
\vO \cdot \vgrad  \psi_p + \ \sigma_t \psi_p - \frac{ \sigma_s }{4 \pi}  \phi_p  = q - \delta \sigma_t \psi + \frac{ \delta \sigma_s }{4 \pi}  \phi  + \delta q 
\]
The LHS is the same essentially the same operator as the forward solution, except applied to $\phi_p$ instead of $\phi$, so it follows that 
\[
\bra \psi^\dag , \vO \cdot \vgrad  \psi_p + \ \sigma_t \psi_p - \frac{ \sigma_s }{4 \pi}  \phi_p  \ket = \bra - \vO \cdot \vgrad  \psi^\dag + \ \sigma_t \psi^\dag - \frac{ \sigma_s }{4 \pi}  \phi^\dag , \psi_p \ket +  \int d^2 r \, \int d  \Omega \, \psi^\dag \psi_p ( \vO \cdot \vec{n})
\]
Convert using the forward and adjoint equations
\[
\bra \psi^\dag ,  q + \delta q - \delta \sigma_t \psi + \frac{ \delta \sigma_s }{4 \pi}  \phi   \ket = \bra q^\dag , \psi_p \ket +  \int d^2 r \, \int d  \Omega \, \psi^\dag \psi_p ( \vO \cdot \vec{n})
\]
The first inner product on the RHS is our perturbed QoI, so
\[
J_p = \bra \psi^\dag ,  q + \delta q - \delta \sigma_t \psi + \frac{ \delta \sigma_s }{4 \pi}  \phi     \ket -  \int d^2 r \, \int d  \Omega \, \psi^\dag \psi_p ( \vO \cdot \vec{n})
\] 
Using $J_p = J + \delta J$, the sensitivity can be found. 
\[
\delta J = \bra \psi^\dag ,  \delta q - \delta \sigma_t \psi + \frac{ \delta \sigma_s }{4 \pi}  \phi    \ket -  \int d^2 r \, \int d  \Omega \, \psi^\dag \delta \psi ( \vO \cdot \vec{n})
\] 
And split the surface integral once again
\[
\delta J = \bra \psi^\dag ,  \delta q - \delta \sigma_t \psi + \frac{ \delta \sigma_s }{4 \pi}  \phi    \ket
- \int d^2 r \, \int_{\vO \cdot \vec{n} >0} d  \Omega \, \psi^\dag \delta \psi ( \vO \cdot \vec{n} ) 
- \int d^2 r \, \int_{\vO \cdot \vec{n} <0} d  \Omega \, \psi^\dag \delta \psi ( \vO \cdot \vec{n} )
\]
So we should know $\delta \psi$ on the incoming for boundary conditions, and we can specify $\psi^\dag$ on the outgoing.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{VEF Formulation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Equation}
Construct linear anisotropic transport equation
\[
\vOmega \cdot \vec{\nabla} \psi + \sigma \psi = \frac{\sigma_{s0} \phi_0 + 3 \sigma_{s1} \vOmega \cdot \vec{\phi_1}}{4 \pi} + q( \vO )
\]
Where
\[
\phi_0=\int d\Omega \, \vO \psi( \vO )
\]
\[
\phi_1=\int d\Omega \, \psi( \vO )
\]
Convert transport equation into coupled 0th and 1st moment equations by applying the $\int d\Omega \bullet $ and $\int d\Omega \vO \bullet$ operator respectively 
\[
\vec{\nabla} \cdot \vec{\phi_1} + \sigma \phi_0 = \sigma_{s0} \phi_0 + q_0
 \]
 \[
\vec{\nabla} \cdot \left(  \int d\Omega \vO \vO \psi \right) + \sigma \vec{\phi_1} =\sigma_{s1} \vec{\phi_1} + \vec{q}_1
 \]
 Of minor importance define $\sigma_r=\sigma-\sigma_{s0}$ and  $\sigma_{tr}=\sigma-\sigma_{s1}$. Then of particular importance define $E$ such that 
 \[
 E=\frac{\int d\Omega \vO \vO \psi}{\phi_0} = \frac{\phi_2}{\phi_0}
 \]
 At which point the coupled system reduces to
 \[
\vec{\nabla} \cdot \vec{\phi_1} + \sigma_r \phi_0 = q_0
 \]
 \[
\vec{\nabla} \cdot \left(E \phi_0 \right) + \sigma_{tr} \vec{\phi_1} =  \vec{q}_1
 \]
 Use 2nd equation to express $\vec{\phi_1}$ in terms of $\phi_0$
\[
\vec{\phi_1}=\frac{\vec{q}_1 - \vec{\nabla} \cdot \left(E \phi_0 \right)  }{\sigma_{tr} }
\]
Substitution into first equation
\[
-\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_0 \right) \right) + \sigma_r \phi_0 = q_0 -  \vec{\nabla} \cdot \frac{1}{\sigma_{tr}} \vec{q}_1 
\]
\subsection{Boundary conditions}
Assume for the boundary condition to the system, the incident angular flux $\psi^{inc}$ is specified. To begin converting to a useful form for VEF, multiply by $| \Omega_i n_i |$ and integrate over incoming angles $\Omega_i n_i <0$
\[
\int_{\Omega_i n_i<0} d\Omega \, \left| \Omega_i n_i \right | \psi^{inc} 
\]
Convert the above into a full $4 \pi$ range interval, and split into two integrals
\begin{align*}
\int_{\Omega_i n_i<0} d\Omega \, \left| \Omega_i n_i \right | \psi^{inc} 
&= \frac{1}{2} \int_{4 \pi} d\Omega \, \left(\left| \Omega_i n_i \right | - \Omega_i n_i  \right)\psi \\
&= \frac{1}{2} \int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \psi - \frac{1}{2} \int_{4 \pi} d\Omega \,  \Omega_i n_i \psi \\ 
\end{align*}
We then recognize that the second term on the RHS is $n_i J_i$. We also multiply the first term by the identity factor.
\[
\frac{\phi}{\int_{4\pi} d\Omega \, \psi} 
\]
So the above becomes
\[
\int_{\Omega_i n_i<0} d\Omega \, \left| \Omega_i n_i \right | \psi^{inc} = \frac{1}{2} \left( \frac{\int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \psi}{\int_{4\pi} d\Omega \, \psi} \right) \phi - \frac{1}{2} n_i J_i
\]
Now define a "Boundary Eddington Factor" B such that
\[
B= \frac{\int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \psi}{\int_{4\pi} d\Omega \, \psi} \quad \vr \in \partial V
\]
We also know
\[
J = \vec{\phi_1}=\frac{\vec{q}_1}{\sigma_{tr} } - \frac{1}{\sigma_{tr} } \vec{\nabla} \cdot \left(E \phi_0 \right)  
\]
So the boundary term becomes 
\[
\int_{\Omega \cdot n<0} d\Omega \, \left| \Omega \cdot n \right | \psi^{inc} = - J^- =  \frac{1}{2} B \phi - \frac{\vec{q}_1}{2 \sigma_{tr} } + \frac{1}{2 \sigma_{tr} } \vec{\nabla} \cdot \left(E \phi_0 \right)  \quad \vr \in \partial V
\]
Then rearrange to what will be the useful form
\[
\frac{1}{\sigma_{tr} } \vec{\nabla} \cdot \left(E \phi_0 \right)  = - 2J^- - B \phi + \frac{\vec{q}_1}{ \sigma_{tr} } \quad \vr \in \partial V
\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{VEF Adjoint Formulation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Test function applied to forward}
The forward VEF formulation, representing using the operator A
\[ -\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right)
+ \sigma_r \phi
= q
\]
\textcolor{red}{always give bc as well}
The corresponding adjoint operator \textcolor{red}{careful, at some point, you should describe (1) where the VEF comes from, (2) state that the adjoint VEF can be defined in 2 manners: the adjoint of the forward VEF, which we will call the math adjoint, and the VEF of the adjoint Sn transport}


Multiply the forward by the test function $\phi^\dag$ (which will become our adjoint) and integrate over space. Focus on the first term. Two integration by parts are performed
\begin{align*}
\int d^3r \, \phi^\dag \left[  -\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \right] 
=& \int d^3r \, \left[ \vgrad \phi^\dag \right] \cdot \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \right] 
- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \cdot \vec{n} \right] \\
=& \int d^3r \, \left[ \frac{1}{\sigma_{tr}} \vgrad \phi^\dag \right] \cdot \left[ \left(  \vdiv \left( E \phi \right) \right) \right] 
- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \cdot \vec{n} \right] \\
=& \int d^3r \, \left[- \vgrad \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right] : \left[ E \phi \right]
+ \int d^2 r \, \left( E \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right) \right) \cdot \vec{n} \\
&- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \cdot \vec{n} \right]\\
=& \int d^3r \, \left[- E^T \vgrad \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right] : \left[ \phi \right] 
+ \int d^2 r \, \left( E \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right) \right) \cdot \vec{n} \\
&- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \cdot \vec{n} \right]
\end{align*}

\subsection{Adjoint equation}
From the previous result we obtain an expression for an adjoint equation
\[ 
E \cdot \left( - \vgrad \left( \frac{1}{\sigma_{tr}} \vgrad \phi^\dag \right) \right)
+ \sigma_r \phi^\dag
= q^\dag
\]
Note that this is NOT the adjoint equation we would expect from an "adjoint particle" transport treatment. We now need to build a boundary condition for the above adjoint. The boundary terms which appeared in the preceding test function formulation are 
\[
 \int d^2 r \, \left( E \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right)^T \right) \cdot \vec{n} 
- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \cdot \vec{n} \right]
\]
Recalling that the boundary condition for the forward was
\[
\frac{1}{\sigma_{tr} } \vec{\nabla} \cdot \left(E \phi \right)  = - 2J^- - B \phi + \frac{\vec{q}_1}{\sigma_{tr} } \quad \vr \in \partial V
\]
Substitution into the boundary term leads to
\[
 \int d^2 r \, \left( E \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right) \right) \cdot \vec{n} 
+ \int d^2 r \, \phi^\dag \left[ \left( 2J^- + B \phi - \frac{\vec{q}_1}{\sigma_{tr} }  \right) \cdot \vec{n} \right] \quad \vr \in \partial V
\]
From the above it appears the the most computationally "beneficial" boundary condition would be specifying 
\[
E \cdot \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) 
\]
Consider the proposed adjoint boundary condition
\[
E \cdot \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) =  - 2J^{ \dag + } - B \phi^\dag  \quad \vr \in \partial V
\]
Which is reminiscent of the forward boundary condition, but with specified outgoing partial current (which is frequently specified for transport derived adjoints. Using the above condition the boundary term becomes. 
\[
 \int d^2 r \, \phi \left[ \left( - 2J^{ \dag + } - B \phi^\dag \right) \cdot \vec{n} \right]
+ \int d^2 r \, \phi^\dag \left[ \left( 2J^- + B \phi + \frac{\vec{q}_1}{\sigma_{tr} } \right) \cdot \vec{n} \right]  \quad \vr \in \partial V
\]
Importantly, the boundary Eddington terms cancel, leaving a total boundary term of
\[
 \int d^2 r \, \left(  2\phi^\dag J^- - 2\phi J^{ \dag + }  -  \frac{\vec{q}_1}{\sigma_{tr}} \right) \cdot \vec{n}
\]
\subsection{QoI via adjoint}
Substitution of the adjoint equation with boundary terms into the test function earlier derivation yields
\[
\bra \phi^\dag , q \ket = \bra \phi, q^\dag \ket +   \int d^2 r \, \left(  2\phi^\dag J^- - 2\phi J^{ \dag + }  -  \frac{\vec{q}_1}{\sigma_{tr}} \right) \cdot \vec{n}
\]

Recognizing $\bra \phi, q^\dag \ket $ is the desired QoI
\[
J = \bra \phi, q^\dag \ket = \bra \phi^\dag , q \ket + \int d^2 r \, \left(  2\phi J^{ \dag + } - 2\phi^\dag J^-  + \frac{\vec{q}_1}{\sigma_{tr}} \right) \cdot \vec{n}
\]
\section{VEF Adjoint Sensitivity}
Assume we perturb $\sigma_{tr}$, $\sigma_r$, and $q_0$; resulting in a perturbed forward solution $\phi_p = \phi + \delta \phi$. Assuming the Eddington tensor remains the same as the unperturbed scenario, we have.
\[
-\vdiv \left( \frac{1}{\sigma_{tr}+\delta \sigma_{tr}} \vdiv \left( E \left( \phi + \delta \phi \right) \right) \right)
+ \left( \sigma_r + \delta \sigma_r \right) \left( \phi + \delta \phi \right)
= q_0 + \delta q_0
\]
For notational compactness, let $c=\frac{1}{\sigma_{tr}}$ and $c + \delta c = \frac{1}{\sigma_{tr}+\delta \sigma_{tr}}$. Expanding the above leads to 
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \delta \phi \right) \right) 
+ \sigma_r \phi_p
+ \delta \sigma_r \phi
+ \delta \sigma_r \delta \phi
= q_0 + \delta q_0 
\]
Drop 2nd order terms
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
+ \sigma_r \phi_p
+ \delta \sigma_r \phi
= q_0 + \delta q_0 
\]
Convert to the suggestive form
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) + \sigma_r \phi_p
= q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
\]
The LHS is simply the operator from the unperturbed scenario, so multiplication (of the first term) by $\phi^\dag$ and integration proceeds the same.
\begin{align*}
\int d^3r \, \phi^\dag \left[  -\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) \right] 
=& \int d^3r \, \left[- E \vgrad \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right] : \left[ \phi_p \right] 
+ \int d^2 r \, \left( E \phi_p \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right) \right) \cdot \vec{n} \\
&- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) \cdot \vec{n} \right]
\end{align*}
Which is the same as the unperturbed case, except extra terms exist on the RHS "source" term in the forward.
\begin{align*}
\bra \phi^\dag , q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) \ket =& \bra \phi_p, q^\dag \ket + \int d^2 r \, \left( E \phi_p \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right)^T \right) \cdot \vec{n} \\
&- \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) \cdot \vec{n} \right]
\end{align*}
Since $\bra \phi_p, q^\dag \ket $ is the desired QoI
\begin{align*}
J = \bra \phi_p, q^\dag \ket =& \bra \phi^\dag , q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket - \int d^2 r \, \left( E \phi_p \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right) \right) \cdot \vec{n} \\
&+ \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) \cdot \vec{n} \right]
\end{align*}
In terms of the change in QoI
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket - \int d^2 r \, \left( E \delta \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right)\right) \cdot \vec{n} \\
&+ \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right]
\end{align*}
Express the first boundary term using the BC of the adjoint
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket + \int d^2 r \, \left(\delta \phi \left( 2J^{ \dag out } + B \phi^\dag \right) \right) \cdot \vec{n} \\
&+ \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right]
\end{align*}
Looking at the second boundary term
\begin{align*}
\left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) 
& = \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) - \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \\
&= (-2J_p^{inc} - B \phi_p) - (-2J^{inc} - B \phi) \\
&= -2\delta J^{inc} -B \delta \phi
\end{align*}
So now for the sensitivity
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket + \int d^2 r \, \left(\delta \phi \left( 2J^{ \dag out } + B \phi^\dag \right) \right) \cdot \vec{n} \\
&+ \int d^2 r \, \phi^\dag \left[ -2\delta J^{inc} -B \delta \phi \right]
\end{align*}
The boundary Eddington terms cancel out, leaving
\[
\delta J = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket + \int d^2 r \, \left(  \delta \phi 2J^{ \dag out }  - \phi^\dag 2\delta J^{inc} \right) \cdot \vec{n} 
\]

\subsection{WAIT, that was wrong!}
Backing up for a second, to where we said
Looking at the second boundary term
\begin{align*}
\left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) 
& = \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) - \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) \\
&= (-2J_p^{inc} - B \phi_p) - (-2J^{inc} - B \phi) \\
&= -2\delta J^{inc} -B \delta \phi
\end{align*}
The above is not strictly true. the first quantity is meaningless, and is not set by any boundary condition
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi_p \right) \right) \neq (-2J_p^{inc} - B \phi_p)
\]
The boundary that is set by our perturbation is
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left( E_p \phi_p \right) \right) = (-2J_p^{inc} - B_p \phi_p)
\]
We can express each term in the LHS using a $\delta$
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left( (E+ \delta E) (\phi + \delta \phi) \right) \right) = (-2J_p^{inc} - B_p \phi_p)
\]
Expanding and dropping the 2nd order term gives
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left( (E \phi + \delta E \phi + E \delta \phi) \right) \right) = (-2J_p^{inc} - B_p \phi_p)
\]
So
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left(  E \delta \phi \right) \right) = (-2J_p^{inc} - B_p \phi_p) - \left( \frac{1}{\sigma_{tr}} \vdiv \left( (E \phi + \delta E \phi ) \right) \right)
\]
Now, we see our unperturbed boundary condition appear
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left(  E \delta \phi \right) \right) = (-2J_p^{inc} - B_p \phi_p) - (-2J^{inc} - B \phi)  - \left( \frac{1}{\sigma_{tr}} \vdiv \left( \delta E \phi  \right) \right)
\]
Combine some terms. We still get the $\delta J $ term as before.
\[
\left( \frac{1}{\sigma_{tr}} \vdiv \left(  E \delta \phi \right) \right) = (-2\delta J^{inc}) - (B_p \phi_p) + (B \phi)  - \left( \frac{1}{\sigma_{tr}} \vdiv \left( \delta E \phi  \right) \right)
\]
Now taking into account the boundary term from the adjoint
\begin{align*}
\delta J =& \bra VolumeTerm \ket + \int d^2 r \, \left(\delta \phi \left( 2J^{ \dag out } + B \phi^\dag \right) \right) \cdot \vec{n} \\
& \quad + \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right] \\
=& \bra VolumeTerm \ket + \int d^2 r \, \left(\delta \phi \left( 2J^{ \dag out } + B \phi^\dag \right) \right) \cdot \vec{n} \\
& \quad + \int d^2 r \, \phi^\dag \left[ \left( (-2\delta J^{inc}) - (B_p \phi_p) + (B \phi)  - \left( \frac{1}{\sigma_{tr}} \vdiv \left( \delta E \phi  \right) \right) \right) \cdot \vec{n} \right] \\
\end{align*}
It is important to remember the definition of $B \phi$ (which extends to $B_p \phi_p$)
\[ B \phi = \int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \psi
\]
So 
\[
-B_p \phi_p + B \phi = - \int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \delta \psi
\]
So our boundary term can now be expressed as
\begin{align*}
\delta J =& \bra VolumeTerm \ket + \int d^2 r \, \left(\delta \phi \left( 2J^{ \dag out } + B \phi^\dag \right) \right) \cdot \vec{n} \\
& \quad + \int d^2 r \, \phi^\dag \left[ \left( (-2\delta J^{inc}) - \left( \int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \delta \psi \right)  - \left( \frac{1}{\sigma_{tr}} \vdiv \left( \delta E \phi  \right) \right) \right) \cdot \vec{n} \right] \\
\end{align*}
So, the first surface term is specified by the adjoint boundary conditions, and should be set to 0. The second boundary term relates to the change in the forward incoming flux ($\delta J^{inc}$) which is what we expect and need to do sensitivity. The fourth term in the above is related to the perturbation of the Eddington $E$ at the boundary, which is something that we should have expected may show up from the beginning. The third term is a bit more unexpected, and seems to related. (We also dropped some second order terms)
\subsection{Form for use in FEM (CORRECT THIS FOR NEW BC)}
For FEM, we would rather avoid the double div term, so consider the VEF sensitivity
\[
\delta J = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket + \bra \phi^\dag , \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket + [\text{Sensitivity Boundary Terms}]
\]
and apply inner product again
\begin{align*}
\delta J = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket - \bra \vgrad \phi^\dag , \left( \delta c \vdiv \left( E \phi \right) \right)  \ket &+ [\text{Sensitivity Boundary Terms}]  \\
&+ \int d^2 r \, \left( \phi^\dag \delta c \vdiv \left( E \phi \right) \right) \cdot \vec{n}
\end{align*}
Recalling that the forward boundary term is (in terms of $c=1/ \sigma_{tr}$ 
\[
c \vec{\nabla} \cdot \left(E \phi \right)  = -2J^- - B \phi \quad \vr \in \partial V
\]
The extra boundary term picked up from the FEM implementation can be expressed as
\begin{align*}
\delta J = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket - \bra \vgrad \phi^\dag , \left( \delta c \vdiv \left( E \phi \right) \right)  \ket &+ [\text{Sensitivity Boundary Terms}]  \\
&+ \int d^2 r \, \left(\frac{\delta c}{c} \phi^\dag  \left(  -2J^- - B \phi \right) \right) \cdot \vec{n}
\end{align*}


\subsection*{Alternate boundary condition for forward. (In Progress)}
Consider the alternate boundary condition for the forward problem \cite{Wiesel}
\[
\vec{n} \cdot \vec{J} + J_{IN} = C (\phi - \phi_{IN})
\]
Expanding out all values
\[
\vec{n} \cdot \int_{4 \pi} d\Omega \, \vO \psi  
+ \int_{\vec{n}\cdot \vO <0} d\Omega \,  \left|\vec{n}\cdot \vO \right| \psi_{IN}
= C \left(  \int_{4 \pi} d\Omega \, \psi   - \int_{\vec{n}\cdot \vO <0} d\Omega \, \psi_{IN} \right)
\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Term from perturbed Eddington}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
For our VEF formulation, the change in QoI approximated to the first order using the adjoint method, while also assuming the Eddington tensor remains remains unperturbed is 
\begin{align*}
\delta QoI =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket - \int d^2 r \, \left( E \delta \phi \cdot \left( \frac{1}{ \sigma_{tr}} \left(  \vgrad \phi^\dag \right) \right)^T \right) \cdot \vec{n} \\
&+ \int d^2 r \, \phi^\dag \left[ \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right].
\end{align*}
where $\delta c = \frac{1}{\sigma_t + \delta \sigma_t} -  \frac{1}{\sigma_t}$.
Let us focus on the volumetric term due to perturbations in $\sigma_t$
\[
\bra \phi^\dag ,  \vdiv \left( \delta c \vdiv \left( E \phi \right) \right)  \ket
\]
since this is the term (or related to the terms) which are affected by our assumption that the Eddington tensor remains unperturbed.

\subsection{Considering a $\delta E$}
If we were to consider a $\delta E = E_{pert} - E$, then our 1st order approximation would pick up an additional volumetric term (while also creating 2 additional 2nd order terms and a 3rd order perturbation term). Ignoring the boundary terms, the inner product would then be
\[
\delta QoI = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) + \vdiv \left( c \vdiv \left( \delta E \phi \right) \right)  \ket
\]
An important take away is that this term is scaled with $c$, remembering $c=1/\sigma_t$, low cross-section regions (streaming) has the potential to make "ignoring" this term very costly.

However, a saving grace MAY be present by way of the divergence operators. Green's identity applied to this term yields
\[
\bra \phi^\dag , \vdiv \left( c \vdiv \left( \delta E \phi \right) \right)  \ket 
= 
\bra -\vgrad \phi^\dag , c \vdiv \left( \delta E \phi \right)  \ket + \int_{\delta V} d^2 r \, \phi^\dag  c \vdiv \left( \delta E \phi \right)
\]
So, if in this streaming region, the adjoint is constant constant we would have $\vgrad \phi^\dag =0$, and the volumetric term disappears, and we can focus on the boundaries of the streaming region. [I think this may cause some unpleasant things to happen when we make the jump from 1D slab geometry to 2D and 3D geometries, where the scalar flux has geometric dependence in streaming regions.]

\subsection{Wait? did we just get lucky.}
So, the "volumetric" sensitivity, that is, the sensitivity that comes directly from the volume integrals of the adjoint process, including the Eddington perturbations but everything to the first order is
\[
\delta J_{vol} = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) + \vdiv \left( c \vdiv \left( \delta E \phi \right) \right)  \ket
\]
We can do some integration by parts on the last two terms to get it to a form that may be preferred in VEF
\begin{align*}
\delta J_{vol} =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket -  \bra \vgrad \phi^\dag ,  \delta c \vdiv \left( E \phi  \right) \ket - \bra \vgrad \phi^\dag ,  c \vdiv \left( \delta E \phi \right)   \ket \\
&+ \int_{\delta V} d^2 r \, \left( \phi^\dag \delta c \vdiv \left( E \phi \right) \right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag  \left(  c \vdiv \left( \delta E \phi \right) \right) \cdot \vec{n}
\end{align*}

Now, look at the sensitivity due to the "Surface" terms. This refers to terms that directly result from the adjoint process, as opposed to the surface terms we picked up in $\delta J_{vol}$ due to other manipulations.

\[
\delta J_{surf} = - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} 
\]
Now we can use the following to express the $E \delta \phi$ term
\begin{align*}
E_p \phi_p &= (E + \delta E)(\phi + \delta \phi) \approx E \phi + E \delta \phi + \delta E \phi  \\
&\to E \delta \phi \approx E_p \phi_p - E \phi - \delta E \phi
\end{align*}
Putting that back in the sensitivity equation
\begin{align*}
\delta J_{surf} =& - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( E_p \phi_p \right) \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left(  E \phi \right) \right) \cdot \vec{n} - \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( \delta E \phi \right) \right) \cdot \vec{n}
\end{align*}
Now use the relation $c =c_p -\delta c $ to expand the second term
\begin{align*}
\delta J_{surf} =& - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag \left( c_p \vdiv \left( E_p \phi_p \right) \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left(  E \phi \right) \right) \cdot \vec{n} - \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( \delta E \phi \right) \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( \delta c \vdiv \left( E_p \phi_p \right) \right) \cdot \vec{n}
\end{align*}
The second and third terms are our boundary conditions for the perturbed and unperturbed case, respectively
\begin{align*}
\delta J_{surf} =& - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag \left(-2J_p^{inc} -B_p \phi_p \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( -2J^{inc} -B \phi \right) \cdot \vec{n} - \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( \delta E \phi \right) \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( \delta c \vdiv \left( E_p \phi_p \right) \right) \cdot \vec{n}
\end{align*}
Rearrange these a little bit to group like terms, and get $\delta J = J_p -J$
\begin{align*}
\delta J_{surf} =& - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} + \int_{\delta V} d^2 r \, \phi^\dag \left(-2\delta J^{inc} \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( B_p \phi_p - B \phi \right) \cdot \vec{n} - \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( \delta E \phi \right) \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( \delta c \vdiv \left( E_p \phi_p \right) \right) \cdot \vec{n}
\end{align*}
NOW combine the surface and volume terms $\delta J = \delta J_{vol} + \delta J_{surf}$, we see that the $c \vdiv \left( \delta E \phi \right)$ surface term cancels out
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket -  \bra \vgrad \phi^\dag ,  \delta c \vdiv \left( E \phi  \right) \ket - \bra \vgrad \phi^\dag ,  c \vdiv \left( \delta E \phi \right)   \ket \\
&+ \int_{\delta V} d^2 r \, \left( \phi^\dag \delta c \vdiv \left( E \phi \right) \right) \cdot \vec{n} 
- \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} \\
&+ \int_{\delta V} d^2 r \, \phi^\dag \left(-2\delta J^{inc} \right) \cdot \vec{n} 
- \int_{\delta V} d^2 r \, \phi^\dag \left( B_p \phi_p - B \phi \right) \cdot \vec{n}  \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( \delta c \vdiv \left( E_p \phi_p \right) \right) \cdot
\end{align*}
Now if you do the first order approximation again (I feel this is being abused at this point)
\[
\delta c \vdiv \left( E_p \phi_p \right) \approx \delta c \vdiv \left( E \phi \right)
\]
Then some more terms cancel
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket -  \bra \vgrad \phi^\dag ,  \delta c \vdiv \left( E \phi  \right) \ket - \bra \vgrad \phi^\dag ,  c \vdiv \left( \delta E \phi \right)   \ket \\
&- \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} 
+ \int_{\delta V} d^2 r \, \phi^\dag \left(-2\delta J^{inc} \right) \cdot \vec{n} \\
&- \int_{\delta V} d^2 r \, \phi^\dag \left( B_p \phi_p - B \phi \right) \cdot \vec{n}  
\end{align*}
Highlighted in red are the terms we gain error from by assuming the Eddington remains unperturbed (including the boundary Eddington B)
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket -  \bra \vgrad \phi^\dag ,  \delta c \vdiv \left( E \phi  \right) \ket  \begingroup\color{red} - \bra \vgrad \phi^\dag ,  c \vdiv \left( \delta E \phi \right)   \ket \endgroup\\
&- \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} 
+ \int_{\delta V} d^2 r \, \phi^\dag \left(-2\delta J^{inc} \right) \cdot \vec{n} \\
& \begingroup\color{red} - \int_{\delta V} d^2 r \, \phi^\dag \left( B_p \phi_p - B \phi \right) \cdot \vec{n} \endgroup
\end{align*}
We might as well represent that last term using the $B\phi$ definition
\begin{align*}
\delta J =& \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi \ket -  \bra \vgrad \phi^\dag ,  \delta c \vdiv \left( E \phi  \right) \ket  \begingroup\color{red} - \bra \vgrad \phi^\dag ,  c \vdiv \left( \delta E \phi \right)   \ket \endgroup\\
&- \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} 
+ \int_{\delta V} d^2 r \, \phi^\dag \left(-2\delta J^{inc} \right) \cdot \vec{n} \\
& \begingroup\color{red} - \int_{\delta V} d^2 r \, \phi^\dag \left( \int_{4 \pi} d\Omega \, \left| \Omega_i n_i \right | \delta \psi \right) \cdot \vec{n} \endgroup
\end{align*}

\subsection{Considering a $\delta B$}
TODO

\subsection{SCRATCH WORK. IGNORE}
The first term will eventually be dealt with using the adjoint boundary conditions. The second term can be split using $\delta \phi = \phi_p - \phi$
\begin{align*}
\delta J_{surf} =& - \int_{\delta V} d^2 r \, \left( E \delta \phi \cdot \left( c  \vgrad \phi^\dag \right)\right) \cdot \vec{n} - \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( E \phi \right) \right) \cdot \vec{n}\\
& 
+ \int_{\delta V} d^2 r \, \phi^\dag \left( c \vdiv \left( E \phi_p \right) \right) \cdot \vec{n}
\end{align*}

\section*{DISCLAIMER}
Below here are just sections where I am "thinking out loud". Some of it is just rambling that leads nowhere.

\section{Some thoughts on a second order boundary term}
There is a potential for some second order boundary term resulting from the $- \vdiv \left( \delta c \vdiv \left( E \delta \phi \right) \right)$ in the expanded perturbed equation. On the boundaries we know $\delta c$ and $\delta \phi$, so we could calculate.
\begin{align*}
\intrrr \phi^\dag \left[ - \vdiv \left( \delta c \vdiv \left( E \delta \phi \right) \right) \right] 
&= \intrrr \delta c  \vgrad \phi^\dag \left[  \left( \vdiv \left( E \delta \phi \right) \right) \right]  - \intrr \phi^\dag \left[  \left( \delta c \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right] \\
&= \intrrr E \vgrad (\delta c  \vgrad \phi^\dag) \left[ \delta \phi  \right]  - \intrr \phi^\dag \left[  \left( \delta c \vdiv \left( E \delta \phi \right) \right) \cdot \vec{n} \right] \\
&\hspace{5mm}+\intrr (\delta c  \vgrad \phi^\dag) \cdot (E \delta \phi \cdot \vec{n}) 
\end{align*}
\textcolor{red}{However, we would never expect to get the boundary terms because we would never apply integration by parts to this term. the $\delta c$ never shows up in the unperturbed operator, so we would never be applying integration by parts to move the operation from $\delta \phi$ to $\phi^\dag$.} In other words, looking at the "suggestive" form from above
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) + \sigma_r \phi_p
= q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
\]
the term would fit in on the right hand "source" side, and not the LHS (which represents the unperturbed operator).




\section{Idea: $f(,\phi,\phi^\dag,\vec{p},\delta\vec{p}) \approx \delta E$?}
What if there exists a "function" $f$; which may be a function of the unperturbed forward flux, the adjoint flux, the input parameters, and the perturbation to those parameters such that $f(,\phi,\phi^\dag,\vec{p},\delta\vec{p}) \approx \delta E$? If so, then we could use this function to "improve" our sensitivity estimation by using
\[
\delta QoI = \bra \phi^\dag , \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) + \vdiv \left( c \vdiv \left( f \phi \right) \right)  \ket
\]


\section{Some thoughts/questions on operators and adjoints}
Ok, we have the forward VEF transport operator
\[
\mathbf{L}\phi =
-\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right) + \sigma_r \phi = q
\]
We also have two adjoint formulations (using the detector response $r$ as the adjoint source). The first being a "transport informed" operator, constructed using an adjoint Eddington factor $E^\dag$
\[
\mathbf{K}^\dag\varphi^\dag = -\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E^\dag \varphi^\dag \right) \right) + \sigma_r \varphi^\dag = r
\]
The other adjoint is the one gained by application of Green's identity to the forward (integration by parts in 1D), which relies on the forward Eddington.
\[ 
\mathbf{L}^\dag \phi^\dag = E : \left( - \vgrad \left( \frac{1}{\sigma_{tr}} \vgrad \phi^\dag \right) \right)
+ \sigma_r \phi^\dag
= r
\]
\subsection*{Equivalence?}
Both adjoints above are true for arbitrary $r$, so it seems to follow that
\[
\mathbf{L}^\dag \phi^\dag = \mathbf{K}^\dag\varphi^\dag 
\]
which in itself is not really remarkable. However, if we introduce our QoI definition.
\[
QoI=\bra \phi , r \ket = \bra \phi , \mathbf{L}^\dag \phi^\dag \ket = \bra \phi , \mathbf{K}^\dag\varphi^\dag \ket
\]
Lets take a second to look at that last one. We transpose the operator to the forward solution $\phi$.
\[
QoI = \bra \phi , \mathbf{K}^\dag\varphi^\dag \ket = \bra \mathbf{K} \phi , \varphi^\dag \ket
\]
Where it can be shown that the operator is
\[
\mathbf{K} \phi =  E^\dag : \left( - \vgrad \left( \frac{1}{\sigma_{tr}} \vgrad \phi \right) \right)
+ \sigma_r \phi
\]
Which is the form of our "math adjoint", but using the adjoint Eddington tensor. Since $\phi$ is known in this context, we get a source term $f$
\[
\mathbf{K} \phi =  E^\dag : \left( - \vgrad \left( \frac{1}{\sigma_{tr}} \vgrad \phi \right) \right)
+ \sigma_r \phi = f
\]
This means our QoI is also given by
\[
QoI = \bra \phi , \mathbf{K}^\dag\varphi^\dag \ket = \bra \mathbf{K} \phi , \varphi^\dag \ket = \bra f , \varphi^\dag \ket
\]
\subsubsection{Perturbations}
So, they only thing really "linking" the forward problem to our "transport adjoint" is that they are both transport informed, which really translates to linked by material properties. SO lets mess around with perturbations for a second.
TO BE CONTINUED, I DONT THINK THIS LINE OF THOUGHT IS GOING ANYWHERE. NOTE TO SELF: Try $q + \delta q = f$
\newpage
\section{SOME SCRATCH WORK ON Operator notation NEEDS REDONE}
The forward VEF formulation, representing using the operator A
\[
A \phi = -\vdiv \left( \frac{1}{\sigma_{tr}} \vdiv \left( E \phi \right) \right)
+ \sigma_r \phi
= q_0 
\]
The corresponding adjoint operator
\[
A^\dag \phi^\dag = E \cdot \left( - \vgrad \left( \frac{1}{\sigma_{tr}} \vgrad \phi^\dag \right) \right)
+ \sigma_r \phi^\dag
= q^\dag
\]
Assume we perturb $\sigma_{tr}$, $\sigma_r$, and $q_0$; resulting in a perturbed forward solution $\phi_p = \phi + \delta \phi$. Assuming the Eddington tensor remains the same as the unperturbed scenario, we have.
\[
-\vdiv \left( \frac{1}{\sigma_{tr}+\delta \sigma_{tr}} \vdiv \left( E \left( \phi + \delta \phi \right) \right) \right)
+ \left( \sigma_r + \delta \sigma_r \right) \left( \phi + \delta \phi \right)
= q_0 + \delta q_0
\]
For notational compactness, let $c=\frac{1}{\sigma_{tr}}$ and $c + \delta c = \frac{1}{\sigma_{tr}+\delta \sigma_{tr}}$. Expanding the above leads to 
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \delta \phi_p \right) \right) 
+ \sigma_r \phi_p
+ \delta \sigma_r \phi
+ \delta \sigma_r \delta \phi
= q_0 + \delta q_0 
\]
Drop 2nd order terms
\[ 
-\vdiv \left( c \vdiv \left( E \phi_p \right) \right) 
- \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
+ \sigma_r \phi_p
+ \delta \sigma_r \phi
= q_0 + \delta q_0 
\]
Convert to the suggestive form
\[ 
A \phi_p
= q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right) 
\]
Our new perturbed QoI is
\[
J_p = \bra \phi_p , q^\dag \ket = \bra \phi_p , A^\dag \phi^\dag\ket
\]
Move the $A^\dag$ operator to the perturbed forward, and sub in the suggestive form from above. (Note, this is the step where we pick up boundary terms)
\[
J_p = \bra \phi_p , A^\dag \phi^\dag\ket =  \bra A \phi_p , \phi^\dag\ket = \bra q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right), \phi^\dag \ket
\]

\subsection{1D with boundary terms}
Lets look at the operator notation step from above
\[
J_p = \bra \phi_p , q^\dag \ket = \bra \phi_p , A^\dag \phi^\dag\ket
\]
Expressing $\bra \phi_p , A^\dag \phi^\dag\ket$ in 1D geometry is
\[\int_a^b dx \, \phi_p \left[ - E  \pdx \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) 
+ \sigma_r \phi^\dag \right]
\]
Since we are just looking for boundary terms, focus on the differential term,
\[\int_a^b dx \, \phi_p \left[ - E  \pdx \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right]
\]
First integration by parts yields
\[\int_a^b dx \, \pdx \left( E \phi_p \right) \left[ \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right] - \left. \left( E \phi_p   \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right)  \right|_a^b
\]
Once more, int by parts
\[\int_a^b dx \,   - \pdx \left( \frac{1}{\sigma_{tr}} \pdx \left( E \phi_p \right) \right)  \left[ \phi^\dag \right] - \left. \left( E \phi_p   \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right)  \right|_a^b + \left. \left( \frac{1}{\sigma_{tr}} \pdx \left( E \phi_p \right) \right) (\phi^\dag) \right|_a^b 
\]
So the two boundary terms we get from this are
\[
- \left. \left( E \phi_p   \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right)  \right|_a^b + \left. \left( \frac{1}{\sigma_{tr}} \pdx \left( E \phi_p \right) \right) (\phi^\dag) \right|_a^b
\]
So
\[
J_p = \bra q_0 + \delta q_0 - \delta \sigma_r \phi + \vdiv \left( \delta c \vdiv \left( E \phi \right) \right), \phi^\dag \ket - \left. \left( E \phi_p   \left( \frac{1}{\sigma_{tr}} \pdx \phi^\dag \right) \right)  \right|_a^b + \left. \left( \frac{1}{\sigma_{tr}} \pdx \left( E \phi_p \right) \right) (\phi^\dag) \right|_a^b
\]

\newpage

\begin{thebibliography}{9}


\bibitem{Wiesel}
  William A. Wieselquest, \emph{The Quasidiffusion Method for Transport Problems on Unstructured Meshes}, North Carolina State University, 2009.




\end{thebibliography}

\textbf{This document was created using \LaTeX}

\end{document}