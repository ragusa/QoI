\documentclass[11pt]{article}
% PACKAGES
\usepackage{graphicx}
\usepackage{tabls}
\usepackage{afterpage}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amstext}
\usepackage{amsbsy}
\usepackage{epsfig}
%\usepackage{cites}
\usepackage{epsf}
\usepackage{float} 
\usepackage{color} 

\usepackage{array}
\usepackage[section]{placeins} % force à mettre l'image où on veut
\usepackage{lscape} %utilisation du mode paysage
\usepackage{xspace}

%\usepackage[pdftex,bookmarks=true]{hyperref}
%\usepackage{hyperref}
\usepackage{url}
\usepackage{verbatim}
%\usepackage[all]{hypcap}

\usepackage[labelsep=quad]{caption} % needed by the breakalgo environment

\usepackage{ifthen}
\usepackage{subfig}

\usepackage{algorithmic}
\usepackage{algorithm}
\usepackage{listings}
%\usepackage[noprefix]{nomencl}  % for nomenclature

%-----------------------------------------------------------
% NEW  DEFINITIONS
% margin par
\newcommand{\mt}[1]{\marginpar{ {\footnotesize #1} }}
% vector shortcuts
\newcommand{\vo}{\vec{\Omega}}
\newcommand{\vr}{\vec{r}}
\newcommand{\vn}{\vec{n}}
\newcommand{\vnk}{\vec{\mathbf{n}}}

% More Quick Commands
% 
\newcommand{\bi}{\begin{itemize}}
\newcommand{\ei}{\end{itemize}}
\newcommand{\ben}{\begin{enumerate}}
\newcommand{\een}{\end{enumerate}}

\renewcommand{\div}{\vec{\nabla}\! \cdot \!}
\newcommand{\grad}{\vec{\nabla}}
\newcommand{\oa}[1]{\fn{\frac{1}{3}\hat{\Omega}\!\cdot\!\overrightarrow{A_{#1}}}}

% common reference commands
\newcommand{\eqt}[1]{Eq.~(\ref{#1})}                     % equation
\newcommand{\fig}[1]{Fig.~\ref{#1}}                      % figure
\newcommand{\tbl}[1]{Table~\ref{#1}}                     % table

%
% Equation beginnings and endings
%
\newcommand{\bea}{\begin{eqnarray}}
\newcommand{\eea}{\end{eqnarray}}

\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\beas}{\begin{eqnarray*}}
\newcommand{\eeas}{\end{eqnarray*}}
\newcommand{\bdm}{\begin{displaymath}}
\newcommand{\edm}{\end{displaymath}}
%
\newcommand{\vj}{\vec{J}}
\newcommand{\sa}[1]{\sigma_{a #1}}
\newcommand{\vl}{\vec{\lambda}}
\newcommand{\vdj}{\delta \vec{J}}
\newcommand{\dphi}{\delta \Phi}
\newcommand{\lmax}{\ensuremath{L_{\textit{max}}}\xspace}
\newcommand{\pmax}{\ensuremath{p_{\textit{max}}}\xspace}
\newcommand{\sddx}{\frac{d}{dx}}
\newcommand{\sddt}{\frac{d}{dt}}
\newcommand{\der}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\vF}{\vec{F}}

\renewcommand{\O}{\mathcal{O}}
\newcommand{\mc}[1]{\mathcal{#1}}
\newcommand{\us}{{u^\ast}}

\newcommand{\ti}{ {t^{\text{init}}} }
\newcommand{\te}{ {t^{\text{end }}} }

\newcommand{\tcr}[1]{\textcolor{red}{#1}}

%-----------------------------------------------------------
\addtolength{\hoffset}{-2.0cm}
\addtolength{\textwidth}{4cm}
\addtolength{\textheight}{4.0cm}
\addtolength{\voffset}{-1.8cm}
\addtolength{\headsep}{-0.3cm}

\setlength{\parindent}{0pt}
\setlength{\parskip}{1.8ex plus 0.5ex minus 0.2ex}

\linespread{1.1}
%-----------------------------------------------------------
\begin{document}
%-----------------------------------------------------------
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{center}
{\huge Adjoint-based sensitivity coefficients for nonlinear problems}\\
{\Large Jean C. Ragusa, TAMU}\\
{\Large \textcolor{red}{No distribution please}}\\
\end{center}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tableofcontents
\pagebreak

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{An analytical example: linear heat conduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{QoI: quantity of interest}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Consider the following heat conduction problem
\be
\label{eq:ex_heat_conduction}
-\frac{d}{dx}k\frac{dT}{dx}=q \qquad x\in [a,b]
\ee
with boundary conditions
\begin{subequations}
\label{eq:ex_heat_conduction_bc}
\be
T(a) = T_{\text{dir}} 
\ee
\be
-k \left.\frac{dT}{dx}\right|_b = h(T(b)-T_{\infty})
\ee
\end{subequations}

Our QoI is a functional of the solution
\be
\label{eq:ex_heat_conduction_qoi}
J = \int_a^b r(x) T(x) dx
\ee
where $r(x)$ is the response function.

Consider the following adjoint problem
\be
\label{eq:ex_heat_conduction_adjoint}
-\frac{d}{dx}k\frac{d\phi}{dx}=r \qquad x\in [a,b]
\ee
with boundary conditions
\begin{subequations}
\label{eq:ex_heat_conduction_bc_adjoint}
\be
\phi(a) = \phi_{\text{dir}} = 0 
\ee
\be
-k \left.\frac{d\phi}{dx}\right|_b = h(\phi(b)-\phi_{\infty}) = h\phi(b)
\ee
\end{subequations}
where we have chosen $\phi_{\text{dir}} = 0$ and $\phi_{\infty}=0$ for reasons that will become clear later.

We now show that we can compute the QoI, $J$, using the adjoint solution. Multiply the forward problem, \eqt{eq:ex_heat_conduction}, by $\phi$; multiply the adjoint problem, \eqt{eq:ex_heat_conduction_adjoint}, by $T$;  integrate over the whole domain; subtract the two quantities. We get:
\be
\label{eq:hc_qoi_derivation1}
\int_a^b \left( -\frac{d}{dx}k\frac{dT   }{dx} \right) \phi dx - 
\int_a^b \left( -\frac{d}{dx}k\frac{d\phi}{dx} \right) T    dx = \int_a^b ( q \phi - r T ) dx = \int_a^b q \phi dx - J
\ee
Integrate by parts once the first integral on the LHS of \eqt{eq:hc_qoi_derivation1}. We get:
\begin{align}
\label{eq:hc_qoi_derivation2}
\int_a^b \left( -\frac{d}{dx}k\frac{dT   }{dx} \right) \phi dx 
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT}{dx} \right) dx 
- \left\{\left.k\frac{dT}{dx}\right|_b \phi(b) - 
         \left.k\frac{dT}{dx}\right|_a \phi(a) \right\} 
\nonumber \\
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT}{dx} \right) dx 
- \left\{-h(T(b)-T_{\infty})\phi(b) - 0 \right\}
\end{align}
The goal of an adjoint simulation is to be able to compute $J$ without having access to $T$ (at least for linear problems). We know $\left.\frac{dT}{dx}\right|_b$ from the boundary conditions on $T$ but we do not know $\left.\frac{dT}{dx}\right|_a$, so it is advantageous to select $\phi(a)=0$.\\
Now, repeat the integration by parts for the second integral on the LHS of \eqt{eq:hc_qoi_derivation1}. We get:
\begin{align}
\label{eq:hc_qoi_derivation3}
\int_a^b \left( -\frac{d}{dx}k\frac{d\phi}{dx} \right) T    dx 
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT}{dx} \right) dx 
- \left\{\left.k\frac{d\phi}{dx}\right|_b T(b) - 
         \left.k\frac{d\phi}{dx}\right|_a T(a) \right\} 
\nonumber \\
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT}{dx} \right) dx 
- \left\{-h\phi(b)T(b) - \left.k\frac{d\phi}{dx}\right|_a T_{\text{dir}} \right\}
\end{align}
Now, you may wonder about $T(b)$ which is not a given (thus one would have to solve the equation for $T$ to get $T(b)$). However, the choice of boundary conditions on $\phi$ at $x=b$ allows for the terms $h\phi(b)T(b)$ to cancel out when 
subtracting \eqt{eq:hc_qoi_derivation2} and \eqt{eq:hc_qoi_derivation3} . 
Next, subtract \eqt{eq:hc_qoi_derivation2} and \eqt{eq:hc_qoi_derivation3} to get the LHS of \eqt{eq:hc_qoi_derivation1}. Re-arrange the result to have:
\be
\int_a^b q \phi dx - J
=
h(T(b)-T_{\infty})\phi(b) 
+
\left\{-h\phi(b)T(b) - \left.k\frac{d\phi}{dx}\right|_a T_{\text{dir}} \right\}
= - h T_{\infty} \phi(b) - \left.k\frac{d\phi}{dx}\right|_a T_{\text{dir}}
\ee

So finally, we have
\be
\label{eq:ex_heat_conduction_qoi_final_expr}
\boxed{
J := \int_a^b rT dx = \int_a^b q \phi dx + h T_{\infty} \phi(b) + \left.k\frac{d\phi}{dx}\right|_a T_{\text{dir}}
}
\ee
Hence, given the boundary conditions for $T$ and given the adjoint solution $\phi$, we can compute the QoI in $T$ for any source distribution without the need to compute $T$ at each time.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sensitivity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We now suppose that the parameters can be perturbed (denoted by the use of $^\prime$).


\be
\label{eq:ex_heat_conduction_pert}
-\frac{d}{dx}k^\prime\frac{dT^\prime}{dx}=q^\prime \qquad x\in [a,b]
\ee
with boundary conditions
\begin{subequations}
\label{eq:ex_heat_conduction_bc}
\be
T(a) = T^\prime_{\text{dir}} 
\ee
\be
-k^\prime \left.\frac{dT^\prime}{dx}\right|_b = h^\prime(T(b)-T^\prime_{\infty})
\ee
\end{subequations}
where we express the perturbed quantities in terms of unperturbed ones + an increment:
\[ 
k^\prime = k + \delta k\,, 
q^\prime = q + \delta q\,, 
h^\prime = h + \delta h\,, 
T^\prime_{\text{dir}}  = T_{\text{dir}} + \delta T_{\text{dir}} \,, 
T^\prime_{\infty}      = T_{\infty}     + \delta T_{\infty}     \,, 
T^\prime = T + \delta T
\]
 
Our new QoI is 
\be
\label{eq:ex_heat_conduction_qoi_pert}
J^\prime = \int_a^b r(x) T^\prime(x) dx = J + \delta J = J + \int_a^b r(x) \delta T(x) dx.
\ee

We now show that we can compute the perturbed QoI, $J^\prime$, using the original adjoint solution. 
Multiply the perturbed forward problem, \eqt{eq:ex_heat_conduction_pert}, by $\phi$; multiply the original adjoint problem, \eqt{eq:ex_heat_conduction_adjoint}, by $\boxed{T^\prime}$;  integrate over the whole domain; subtract the two quantities. We get:

\be
\label{eq:hc_pert_qoi_derivation1}
\int_a^b \left( -\frac{d}{dx}k^\prime\frac{dT^\prime   }{dx} \right) \phi dx - 
\int_a^b \left( -\frac{d}{dx}k\frac{d\phi}{dx} \right) T^\prime    dx = \int_a^b ( q^\prime \phi - r T^\prime ) dx = \int_a^b q^\prime \phi dx - J^\prime
\ee
Integrate by parts once the first integral on the LHS of \eqt{eq:hc_pert_qoi_derivation1}. We get:
\begin{align}
\label{eq:hc_pert_qoi_derivation2}
\int_a^b \left( -\frac{d}{dx}k^\prime\frac{dT^\prime   }{dx} \right) \phi dx 
&= 
\int_a^b \left( k^\prime\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \left\{\left.k^\prime\frac{dT^\prime}{dx}\right|_b \phi(b) - 
         \left.k^\prime\frac{dT^\prime}{dx}\right|_a \phi(a) \right\} 
\nonumber \\
&= 
\int_a^b \left( k^\prime\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \left\{-h^\prime(T^\prime(b)-T^\prime_{\infty})\phi(b) - 0 \right\}
\end{align}
Repeat for the second integral on the LHS of \eqt{eq:hc_pert_qoi_derivation1}. We get:
\begin{align}
\label{eq:hc_pert_qoi_derivation3}
\int_a^b \left( -\frac{d}{dx}k\frac{d\phi}{dx} \right) T^\prime    dx 
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \left\{\left.k\frac{d\phi}{dx}\right|_b T^\prime(b) - 
         \left.k\frac{d\phi}{dx}\right|_a T^\prime(a) \right\} 
\nonumber \\
&= 
\int_a^b \left( k\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \left\{-h\phi(b)T^\prime(b) - \left.k\frac{d\phi}{dx}\right|_a T^\prime_{\text{dir}} \right\}
\end{align}

Subtract \eqt{eq:hc_pert_qoi_derivation2} and \eqt{eq:hc_pert_qoi_derivation3} to get the LHS of \eqt{eq:hc_pert_qoi_derivation1}. Re-arrange the result to have:
\be
\int_a^b q^\prime \phi dx - J^\prime
=
\int_a^b \left( \delta k\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
+
\delta h T^\prime(b) \phi(b) - h^\prime T^\prime_{\infty} \phi(b) 
- \left.k\frac{d\phi}{dx}\right|_a T^\prime_{\text{dir}} 
\ee

So finally, we have
\be
\label{eq:ex_heat_conduction_pert_qoi_final_expr}
\boxed{
J^\prime := \int_a^b r T^\prime dx 
= 
\int_a^b q^\prime \phi dx 
- \int_a^b \left( \delta k\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \delta h T^\prime(b) \phi(b) + h^\prime T^\prime_{\infty} \phi(b) 
+ \left.k\frac{d\phi}{dx}\right|_a T^\prime_{\text{dir}} 
}
\ee


Subtracting \eqt{eq:ex_heat_conduction_pert_qoi_final_expr} and \eqt{eq:ex_heat_conduction_qoi_final_expr}, we get:
\be
\label{eq:ex_heat_conduction_delta_qoi_expr}
\boxed{
\delta J := \int_a^b r \delta T dx 
= 
\int_a^b \delta q \phi dx 
- \int_a^b \left( \delta k\frac{d\phi}{dx}\frac{dT^\prime}{dx} \right) dx 
- \delta h T^\prime(b) \phi(b) + \left[ h^\prime T^\prime_{\infty} - h T_{\infty} \right] \phi(b) 
+ \left.k\frac{d\phi}{dx}\right|_a \delta T_{\text{dir}} 
}
\ee
To first order, we can now replace $T^\prime:= T + \delta T$ with simply the unperturbed function $T$ (dropping terms that would then be $\delta ^2$):
\be
\label{eq:ex_heat_conduction_delta_qoi_expr_final}
\boxed{
\delta J \simeq \int_a^b r \delta T dx 
= 
\int_a^b \delta q \phi dx 
- \int_a^b \left( \delta k\frac{d\phi}{dx}\frac{dT}{dx} \right) dx 
- \delta h T(b) \phi(b) + \left[ h^\prime T^\prime_{\infty} - h T_{\infty} \right] \phi(b) 
+ \left.k\frac{d\phi}{dx}\right|_a \delta T_{\text{dir}} 
}
\ee
Now, we only need to compute the unperturbed $T$, the (unperturbed) adjoint $\phi$, and we can compute sensitivities to any parameter without having to compute the perturbed $T^\prime=T+\delta T$.

An important note: I find it easier to start with the perturbed problem (the equation in $T^\prime$) rather than starting from a equation for the perturbation only ($\delta T$). The reason is that the boundary conditions for the governing equation in $\delta T$ are not necessarily obvious.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The adjoint operator in this linear example}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Previous, we admitted the functional for of the adjoint operator for the linear heat conduction. The adjoint equation was given in \eqt{eq:ex_heat_conduction_adjoint} without much justification.

Basically, the adjoint operator is obtained by reversing the operations in the following integral:
\[
\int \left( -\frac{d}{dx}k\frac{dT}{dx} \right) \phi 
\]
The goal is to remove $T$ from the differential operators. This is obtained by integrating the following expression by part, twice:
\begin{align}
\int \left( -\frac{d}{dx}k\frac{dT}{dx} \right) \phi 
&= \int \frac{d\phi}{dx}k\frac{dT}{dx}  - \left. k\frac{dT}{dx}\phi\right|_0^L \nonumber\\
&=
\int \left(-\frac{d}{dx}k\frac{d\phi}{dx} \right)T  + \left. k\frac{d\phi}{dx}T\right|_a^b  - \left. k\frac{dT}{dx}\phi\right|_a^b 
\end{align}

From this, we note that we have
\[
\int q \phi = \int T r + \left. k\frac{d\phi}{dx}T\right|_a^b  - \left. k\frac{dT}{dx}\phi\right|_a^b \,,
\] 
expression which we derived and used previously to link $J=\int Tr$ with the adjoint solution $\phi$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{In operator notation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We can also write these matters succinctly. Let the forward problem be
\[
A T = q
\]
and the adjoint problem be
\[
A^\star \phi = r
\]
If we define an inner product of the phase-space as
\[
\langle f,g \rangle
\]
then the QoI functional is
\begin{equation}
J = \langle T, r \rangle = \langle T, A^\star \phi \rangle = \langle \left(A^{\star}\right)^t T, \phi \rangle 
\end{equation}
where $^t$ denotes the transpose operation. Then, we have the following $J = \langle T, r \rangle = \langle q, \phi \rangle$ 
\[
\text{only if } \quad \left(A^{\star}\right)^t = A, \text{  that is, if  } \quad A^{\star} = A^t
\]
Note that for symmetric operator $A^t=A$, and thus the operator $A$ is self-adjoint, $A=A^{\star}$.

Also note that this discussion omits details about boundary conditions, so the operator notation should be used carefully,

Let's finish by the sensitivity expression using operators. Consider the unperturbed and perturbed forward problems and the unperturbed adjoint problem:
\begin{subequations}
\begin{equation}\label{eq:linear_oper_for_unpert}
A T =q
\end{equation}
\begin{equation}\label{eq:linear_oper_for_pert}
(A+\delta A)(T+\delta T) = q + \delta q
\end{equation}
\begin{equation}\label{eq:linear_oper_adj_unpert}
A^\star \phi = r
\end{equation}
\end{subequations}
Compute the following inner products
\begin{align}
&\langle \phi, q+\delta q\rangle = \langle \phi, (A+\delta A)(T+\delta T)\rangle  = \langle \phi, AT \rangle + \langle \phi, A\delta T\rangle + \langle \phi, \delta A T \rangle + \mathcal{O}(\delta^2) \\
&\langle T+\delta T, A^\star \phi  \rangle = \langle T+\delta T, r \rangle = J + \delta J
\end{align}
Simplifying each expression yields
\begin{align}
&\langle \phi, \delta q\rangle =  \langle \phi, A\delta T\rangle + \langle \phi, \delta A T \rangle + \mathcal{O}(\delta^2) \\
&\langle (A^\star)^t\delta T, \phi  \rangle = \delta J
\end{align}

If $(A^\star)^t=A$ (that's how we define the adjoint operator), then
\[
\delta J = \langle \phi, A \delta T \rangle = \langle \phi, \delta q - \delta A T \rangle + \mathcal{O}(\delta^2)
\]
that is, the variation of $J$ due to a change in the source $q$ (i.e., $\delta q$) or in the operator $A$ (i.e., $\delta A$), can be computed using only the solutions to the unperturbed forward and adjoint problems, $T$ and $\phi$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{FEM discretization and boundary conditions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Neumann bc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Consider the general analytical expression 
\[
J := \int_a^b rT dx 
= \int_a^b q \phi dx + \left( \left.k \frac{dT}{dx}\right|_b\phi(b) -\left.k \frac{dT}{dx}\right|_a\phi(a) \right)
-\left( \left.k \frac{d\phi}{dx}\right|_bT(b) -\left.k \frac{d\phi}{dx}\right|_aT(a) \right) 
\]
For a forward problem with non-homogeneous Neumann boundary conditions, e.g.,
\[
\left.+k \frac{dT}{dx}\right|_a = \Psi_a
\qquad 
\left.-k \frac{dT}{dx}\right|_b = \Psi_b
\]
we have an adjoint problem with homogeneous Neumann bc, $\left.\frac{d\phi}{dx}\right|_a = \left.\frac{d\phi}{dx}\right|_b=0$.
Hence, the analytical expression becomes
\[
J := \int_a^b rT dx 
= \int_a^b q \phi dx + \left( -\Psi_b\phi(b) -\Psi_a\phi(a) \right)
\]

In the FEM discreetization, the RHS of the adjoint problem $r$, is unchanged because of the homogeneous bc. For the forward problem,
leads to the RHS vector $q$ which contains $\int q b_i$ is augmented by the values $-\Psi_a$ and $-\Psi_b$ in the appropriate row (here $q_1$ and $q_N$).

Thus, the discrete expression 
\[
J = \langle T, r \rangle = \langle q, \phi \rangle
\]
already contains the modifications needed in the analytical expression and nothing is required to compare the numerical $J$ and the analytical $J$.

\subsubsection{Robin bc}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The principle is the same as for Neumann bc. The forward problem has a non-homogeneous Robin bc, e.g., $h(T(b)-T_{\infty,b})$, while the adjoint problem has an homogeneous Robin bc, e.g., $h\phi(b)$. 

The parts that contains the solution variables, $hT(b)$ for the forward problem and $h\phi(b)$ for the adjoint problem become part of the linear system matrices $A$ and $A^\star=A^t$.

The forward RHS vector $q$ is augmented by the non-homogeneous portion, $hT_{\infty,b}$ in the appropriate row. The adjoint RHS vector $r$ is unchanged due to the homogeneous nature of the bc.

What is left of the analytical $J$ is
\[
J := \int_a^b rT dx 
= \int_a^b q \phi dx + hT_{\infty,b}\phi(b) + hT_{\infty,a}\phi(a)
\]
The discrete expression 
\[
J = \langle T, r \rangle = \langle q, \phi \rangle
\]
already contains the modifications needed in the analytical expression and nothing is required to compare the numerical $J$ and the analytical $J$.

\subsubsection{Dirichlet bc}
Here, we impose the non-homogeneous bc in the forward problem, $T(a)=T_{\text{dir},a}$ and $T(b)=T_{\text{dir},b}$, while the adjoint problem has homogeneous Dirichlet bc, $\phi(a)=\phi(b)=0$.

The Dirichlet bc impose a modification of the linear system (the same modifications are applied to $A$ and $A^\star$, thus we still have $A^\star=A^t$). Now we have $q_1=T_{\text{dir},a}$ and $q_N=T_{\text{dir},b}$ for the forward problem and $r_1=r_N=0$ for the adjoint problem. In addition, in order \ keep the linear system matrix symmetric, the following modifications are made to $q$
\[
q_2 \leftarrow q_2 -A_{2,1}T_{\text{dir},a} \qquad
q_{N-1} \leftarrow q_{N-1} -A_{N-1,N}T_{\text{dir},b}
\] 

The analytcial expression for $J$ is (we used $\phi(a)=\phi(b)=0$)
\[
J := \int_a^b rT dx 
= \int_a^b q \phi dx 
-\left( \left.k \frac{d\phi}{dx}\right|_b T_{\text{dir},b} -\left.k \frac{d\phi}{dx}\right|_a T_{\text{dir},a}\right) 
\]

The discrete expression is missing the original values of $r_1$ and $r_N$ in the inner product so the numerical $J$ 
\[
J = \langle T, r \rangle = \langle q, \phi \rangle
\]
must be augmented by 
\[
T_{\text{dir},a} \int r(x) b_1(x) + T_{\text{dir},b} \int r(x) b_N(x)
\]
to yield the correct answer.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A nonlinear example: nonlinear heat conduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{QoI: quantity of interest}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Consider the following \tcr{nonlinear} heat conduction problem
\be
\label{eq:ex_heat_conduction}
-\frac{d}{dx}k\tcr{(T)}\frac{dT}{dx}=q \qquad x\in [a,b]
\ee
with boundary conditions
\begin{subequations}
\label{eq:ex_heat_conduction_bc}
\be
T(a) = T_{\text{dir}} 
\ee
\be
-k(T) \left.\frac{dT}{dx}\right|_b = h(T(b)-T_{\infty})
\ee
\end{subequations}

Our QoI is a functional of the solution
\be
\label{eq:ex_heat_conduction_qoi}
J = \int_a^b r(x) T(x) dx
\ee
where $r(x)$ is the response function.

Consider the following adjoint problem
\be
\label{eq:ex_heat_conduction_adjoint}
-\frac{d}{dx}k(T)\frac{d\phi}{dx}=r \qquad x\in [a,b]
\ee
with boundary conditions
\begin{subequations}
\label{eq:ex_heat_conduction_bc_adjoint}
\be
\phi(a) = \phi_{\text{dir}} = 0 
\ee
\be
-k(T) \left.\frac{d\phi}{dx}\right|_b = h(\phi(b)-\phi_{\infty}) = h\phi(b)
\ee
\end{subequations}
where we have chosen $\phi_{\text{dir}} = 0$ and $\phi_{\infty}=0$ for reasons that were explained previously. Do note that the adjoint problem is now \tcr{linear} but requires that the forward solution $T$ be known.

The rest of the derivation for the QoI, $J$, is identical to the one for the linear heat conduction problem. We do not reproduce here and just give the final result
\be
\boxed{
J := \int_a^b rT dx = \int_a^b q \phi dx + h T_{\infty} \phi(b) + \left.k\frac{d\phi}{dx}\right|_a T_{\text{dir}}
}
\ee


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sensitivity for a nonlinear problem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Now things get really interesting. Notably the adjoint problem will be different than the previous ones seen so far.

Let us consider the unperturbed and perturbed forward problems ($p$ denotes a parameter):
\[
-\frac{d}{dx}k(T,p)\frac{dT}{dx} = q \qquad \text{with bc: } \left.\frac{dT}{dx}\right|_0=0 \ \text{  and } -k(T,p)\left.\frac{dT}{dx}\right|_L=h(T(L)-T_\infty)
\]
and
\[
-\frac{d}{dx}\left[\left(k(T,p)+\left.\frac{\partial k}{\partial T}\right|_{T,p}\delta T+\left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p\right) \frac{d(T+\delta T)}{dx}\right] = q+\delta q \]
where we have used a first-order expansion for the perturbations in conductivity
\[
k(T+\delta T, p+\delta p) \simeq k(T,p)+\left.\frac{\partial k}{\partial T}\right|_{T,p}\delta T+\left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p
\]
The perturbed boundary conditions are as follows: 
\[
 \left.\frac{d(T+\delta T)}{dx}\right|_0=0 \ \text{ and } -k(T+\delta T, p+\delta p)\left.\frac{d(T+\delta T)}{dx}\right|_L=(h+\delta h)(T(L)+\delta T(L)-T_\infty-\delta T_\infty)
\]

/We would like to subtract these two equations to obtain an equation for $\delta T$. However, in order to include the boundary conditions, we multiply both unperturbed and perturbed forward equations by $\phi$ and integrate by parts. This yields, for both equations,
\begin{equation}
\int q\phi = \int k(T,p)\frac{dT}{dx}\frac{d\phi}{dx} - \left.k(T,p)\frac{dT}{dx}\phi\right|_0^L  
= \int k(T,p)\frac{dT}{dx}\frac{d\phi}{dx} +h(T(L)-T_\infty) \phi(L) 
\end{equation}
and
\begin{equation}
\int (q+\delta q)\phi = \int k(T+\delta T,p+\delta p)\frac{d(T+\delta T)}{dx}\frac{d\phi}{dx} +(h+\delta h)(T(L)+\delta T(L)-T_\infty-\delta T_\infty) \phi(L) 
\end{equation}

Subtract the above two equations (now, we will obtain the weak form of the equation for $\delta T$ and the appropriate bc will naturally be evaluated in that process). We only keep first-order terms in the unknowns.
\begin{multline}
\int \delta q\phi = \int \left(\left.\frac{\partial k}{\partial T}\right|_{T,p}\delta T+\left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p\right) \frac{dT}{dx}\frac{d\phi}{dx} + \int k(T,p)\frac{d\delta T}{dx}\frac{d\phi}{dx} \\
+h(\delta T(L)-\delta T_\infty)  \phi(L)
+\delta h(T(L)-T_\infty)  \phi(L)
\end{multline}

Let us place everything that does not depend on $\delta T$ on the RHS:
\begin{multline}
\label{eq:sensitivity_nonlinear_hc_1}
\int \delta q\phi 
-\int \left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p \frac{dT}{dx}\frac{d\phi}{dx} 
-\delta h(T(L)-T_\infty)  \phi(L)
\\=
\int \left.\frac{\partial k}{\partial T}\right|_{T,p}\delta T \frac{dT}{dx}\frac{d\phi}{dx} 
+ \int k(T,p)\frac{d\delta T}{dx}\frac{d\phi}{dx} 
+h(\delta T(L)-\delta T_\infty)  \phi(L)
\end{multline}

Remember that we seek 
\[
\delta J = \langle \delta T, r \rangle = \langle \delta T, A^\star \phi \rangle 
\]
hence we need to remove all differential operators for $\delta T$ in \eqt{eq:sensitivity_nonlinear_hc_1}. Thus, we need to integrate by parts the second integral in the RHS of \eqt{eq:sensitivity_nonlinear_hc_1}:
\[
\int k(T,p)\frac{d\delta T}{dx}\frac{d\phi}{dx} 
=
-\int \frac{d}{dx}k(T,p)\frac{d\phi}{dx} \delta T + \left.k(T,p)\frac{d\phi}{dx}\delta T\right|_0^L
\]

This tells us two things
\begin{enumerate}
\item the boundary conditions for $\phi$ should be
\[
\left.k(T,p)\frac{d\phi}{dx}\right|_L = -h\phi(L) \quad \text{and} \quad \left.\frac{d\phi}{dx}\right|_0 = 0
\]
\item The adjoint operator is (recall, the response function $r$ is the adjoint source)
\[
r=A^\star \phi  = -\frac{d}{dx}k(T,p)\frac{d\phi}{dx} + \left.\frac{\partial k}{\partial T}\right|_{T,p} \frac{dT}{dx}\frac{d\phi}{dx} 
\]
$A^\star$ is linear in $\phi$ and depends ont he unperturbed solution $T$.
\end{enumerate}

Now, \eqt{eq:sensitivity_nonlinear_hc_1} becomes
\begin{multline}
\int \delta q\phi 
-\int \left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p \frac{dT}{dx}\frac{d\phi}{dx} 
-\delta h(T(L)-T_\infty)  \phi(L)
\\=
\underbrace{
\int \left(
- \frac{d}{dx}k(T,p)\frac{d\phi}{dx} 
+ \left.\frac{\partial k}{\partial T}\right|_{T,p} \frac{dT}{dx}\frac{d\phi}{dx} 
\right) 
\delta T 
}
_{=\langle r,\delta T \rangle = \delta J}
%-h\phi(L)\delta T(L)
%+h(\delta T(L)-\delta T_\infty)  \phi(L)
-h\delta T_\infty \phi(L)
\end{multline}

Finally, we have
\be
\boxed{
\delta J = 
\int \delta q\phi 
-\int \left.\frac{\partial k}{\partial p}\right|_{T,p}\delta p \frac{dT}{dx}\frac{d\phi}{dx} 
-\left(\delta h(T(L)-T_\infty)  - h\delta T_\infty \right)\phi(L)
}
\ee
where $\phi$ is the adjoint solution of the following problem:
\[
A^\star \phi  = -\frac{d}{dx}k(T,p)\frac{d\phi}{dx} + \left.\frac{\partial k}{\partial T}\right|_{T,p} \frac{dT}{dx}\frac{d\phi}{dx} = r
\]
with boundary conditions:
\[
-\left.k(T,p)\frac{d\phi}{dx}\right|_L = h\phi(L) \quad \text{and} \quad \left.\frac{d\phi}{dx}\right|_0 = 0
\]
\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Governing PDE}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------
\subsubsection{General Case}
%----------------------

Consider an operator $\O$ dependent on a set of parameters $p$. The operator is assumed
to be nonlinear, so it also depend on the solution $u$. Let $X$ be the domain and $\partial X=\Gamma$
its boundary. We denote by the subscript $0$ the unperturbed state. $u_0$ is solution of the following
sets of equations:
\begin{align}
\O(u_0,p_0) u_0 &= Q(p_0), \qquad x\in X \label{eq:gov} \\
\mc{C}(u_0,p_0) u_0 &=u_\Gamma(p_0), \qquad x \in \partial X=\Gamma \label{eq:BCgov}
\end{align}

When dealing with transient problems, I still single out the time derivative as follows:
\be
\O(u,p) = \mc{A}(u,p)\partial_t + \mc{B}(u,p)
\ee

Later, we will consider a perturbation of the form
\be
p = p_0 + \epsilon p_1
\ee
that will lead to a perturbation in $u$
\be
u=u_0 + \epsilon u_1 + \ldots
\ee

%----------------------
\subsubsection{Linear diffusion}
%----------------------

Consider the linear 1-g neutron diffusion (in a 1-D slab for the numerical results)

\be
-\div D(p) \grad u  + \Sigma_a(p) u = Q(p) \qquad \text{for } a<x<b
\ee
with vacuum BC
\be
u(a)=u(b)=0
\ee

A transient version of this problem is
\be
\frac{1}{v(p)} \partial_t u -\div D(p) \grad u  + \Sigma_a(p) u = Q(p) \qquad \text{for } a \le x \le b
\ee
with given initial conditions $u^{\text{init}}(x,0)$.

Here, we have
\be 
\mc{A} = \frac{1}{v} \qquad  \mc{B} =  -\div D \grad   + \Sigma_a 
\ee

%----------------------
\subsubsection{Nonlinear heat conduction}
%----------------------

Consider the nonlinear heat conduction (in a 1-D slab for the numerical results)
\be
-\div k(u,p)  \grad u = q \qquad \text{for } a \le x \le b
\label{eq:heat_conduction}
\ee
with boundary conditions
\begin{align}
u(a) &= u^D \\
\varphi_u(b) &=  -k \grad u \cdot \vec{n} |_{x=b}= -k \partial_n u |_{x=b} = \phi^N
\end{align}
(a Dirichlet BC at $a$ and a Neumann BC at $b$).

A transient version of this problem is
\be
\rho C_p(p) \partial_t u -\div k(u,p)  \grad u = q \qquad \text{for } a \le x \le b
\label{eq:heat_conduction_transient}
\ee
with boundary conditions
\begin{align}
u(a,t) &= u^D(t) \\
\varphi_u(b,t) &=  -k \grad u \cdot \vec{n} |_{x=b}= -k \partial_n u |_{x=b} = \phi^N(t)
\end{align}

and a given initial condition $u^{\text{init}}(x,0)$.

Here, we have
\be 
\mc{A} = \rho C_p \qquad  \mc{B} =  -\div k(u)  \grad
\ee

%Let the operator $\O$ be such that
%\be
%\O(u,p) u = -\div k(u)  \grad u
%\ee
%that is, $\O=-\div k(u)  \grad \cdot$, and $p$ be an uncertain parameter (here, 
Say the conductivity is the uncertain parameter ($\longrightarrow k(u,p)$). 
To give an idea, we can take, for example, 
\be
k(u,\alpha,\,\beta,\gamma) = \frac{\alpha}{\beta + \gamma u}
\ee
where the coefficients $\alpha,\,\beta,$ and $\gamma$ are the ``uncertain'' parameters.



%----------------------
\subsubsection{Coupled nonlinear problem: radiation diffusion and material temperature}
%----------------------

\begin{align}
\frac{1}{c} \partial_t E - \div D_E(T,E) \grad E + \sigma_a(T)(E-acT^4) &= 0 \\
C_v \partial_t T -\div D_T(T) \grad T +\sigma_a(T)(acT^4-E)            &= 0
\end{align}

supplemented with appropriate boundary and initial conditions.

I have omitted to explicitly mention at possible dependence on a generic parameter $p$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Quantity of interest: QoI}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------
\subsubsection{Steady-state QoI}
%----------------------

We are interested in the following quantity of interest
\be
QoI[u,p] = (\sigma, u) = \int_X  dx \, \sigma(x)u(x)
\ee

Examples of $\sigma(x)$:
\begin{table*}[!h]
	
	\begin{center}
		\begin{tabular}{|l||c|}
		\hline
	local value at $x_0$ & $\delta(x-x_0)$ \\ \hline
	derivative value at $x_0$ & $\delta(x-x_0) \frac{\partial}{\partial x}$ \\ \hline
	average over region of interest $\mathcal{R}$ & $\frac{1}{\tt{meas}(\mathcal{R})} \chi(x)$ with $\chi(x)=1$ if $x\in\mathcal{R}$ and 0 otherwise \\ \hline
		\end{tabular}
	\end{center}
	\caption{Examples of response functions}
	\label{tab:ExamplesOfResponseFunctions}
\end{table*}

%----------------------
\subsubsection{Transient QoI}
%----------------------

For transient problems, this becomes
\be
QoI[u,p] = (\sigma, u) = \int_\ti ^\te dt \int_X  dx \, \sigma(x,t)u(x,t)
\ee

The time dependence of $\sigma(x,t)$ can be 
\begin{itemize}
\item $\frac{1}{t^{\text{end}}-t^{\text{init}}}$: i.e., time average over the entire simulation time 
\item $\frac{1}{t_2-t_1}$: i.e., time average over a subset over the simulation period
\item $\delta(t-t_0)$: i.e., an instantaneous quantity at time $t_0$
\item \ldots
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Adjoint operator}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------
\subsubsection{General Case}
%----------------------

Multiply \eqt{eq:gov} by $\us(x,t)$ and integrate over space (and time if transient)
\be
\label{eq:duality}
(\us,\O(u,p)u) = (\O^\ast(u,p)\us,u) + W(\us,u)
\ee
This defines how to construct the adjoint problem.
$W(\us,u)$ is the concomitant and is the result of integration by parts in space (and time, if transient). 
\eqt{eq:duality} is called a duality relation.


Later, when it will be time to actually solve for the adjoint solution, $\us$, the following problem will be
posed, where the rhs will be the characteristic function appearing in the QoI:
\be
\O^\ast(u,p)\us = \sigma
\ee
%

%----------------------
\paragraph{Temporal portion of the operator:}
%----------------------

\be
(\us,\mc{A} \partial_t u ) 
=  \int_\ti^\te dt \int_X dx \, \us \mc{A} \partial_t u
= -\int_\ti^\te dt \int_X dx \, u  \partial_t (\mc{A}\us) + 
\left. \int_X dx \, u \mc{A} \us \right|_\ti^\te 
\ee

Note the time reversal.
If $\mc{A}$ is independent of time, then we also have 
\be
(\us,\mc{A} \partial_t u )  
= -(u , \mc{A} \partial_t \us ) + 
\left. \int_X dx \, u \mc{A} \us \right|_\ti^\te 
\ee

%----------------------
\subsubsection{Linear diffusion}
%----------------------

Recall that $ \mc{B} =  -\div D \grad   + \Sigma_a $. We have for the steady-state case:
\be
(\us,\mc{B}u) = (\mc{B}^\ast\us,u) + W(\us,u)
\ee
where
\be
\mc{B}^\ast= \mc{B} =  -\div D \grad   + \Sigma_a 
\ee
\be
W(\us,u) = \langle u, \mc{L} \us \rangle  -  \langle \us, \mc{L} u \rangle
\ee
with $\mc{L} = n \cdot D\grad$ and $\langle \  , \, \rangle = \int_{\Gamma}\ $.


For the transient case (recall that $\mc{A} = \frac{1}{v}$), we have the following duality relation
\be
(\us,\mc{A}\partial_t u + \mc{B}u) = (-\mc{A}\partial_t \us +\mc{B}^\ast\us,u) + W(\us,u) + \left. \int_X \, u \mc{A} \us \right|_\ti^\te 
\ee
and the adjoint operator is:
\be
\O^\ast \us = -\frac{1}{v} \partial_t \us  -\div D \grad \us  + \Sigma_a \us 
\ee

%----------------------
\subsubsection{Nonlinear heat conduction}
%----------------------

\paragraph{Steady state} 

Multiply \eqt{eq:gov} by $\us(x)$ and integrate by parts (twice)
\be
(\us,\O(u,p)u) = (\O^\ast(u,p)\us,u) + W(\us,u)
\ee
where the adjoint (linear) problem is
\be
\O^\ast(u,p)\us = -\div k(u)  \grad \us = \sigma
\ee
%
$W(\us,u)$ is
\be
W(\us,u) = u(b)\varphi_\us(b)-u(a)\varphi_\us(a) -\left( \us(b)\varphi_u(b) -\us(a)\varphi_u(a)\right)
\ee
%where we recall that
%\begin{align}
%\varphi_u   &= - k \grad u   \cdot \vec{n} \\
%\varphi_\us &= + k \grad \us \cdot \vec{n} 
%\end{align}
%[{\bf caveat:} change of sign]. 
I prefer a more concise notation. Introducing
\be
\mc{L} = n \cdot D\grad
\ee where $n$ is the {\bf outward} unit normal vector on the boundary, 
we have
\be
(\us, \O(u,p)u) + \langle \us, \mc{L} u \rangle = (u, \O^\ast(u,p)\us) + \langle u, \mc{L} \us \rangle 
\ee
with $\langle \  , \, \rangle = \int_{\Gamma}\ $.

Thus,
\be
W(\us,u) = \langle u, \mc{L} \us \rangle  -  \langle \us, \mc{L} u \rangle
\ee
and the steady state QoI is given by 
\be
QoI[u,p] = (\sigma, u) = (\O^\ast(u,p)\us, u) = (\us,\O(u,p)u) - W(\us,u) = (\us,Q(p)) - W(\us,u)
\ee
{\bf Note:} the QoI can be evaluated using $\us$. The fact that $u$ and $\us$ appear in $W$ is ok 
because $W$ only needs boundary values, which should be known.

\paragraph{Transient} 
For the transient case (recall that $\mc{A} = \rho C_p$), we have the following duality relation
\be
(\us,\mc{A}\partial_t u + \mc{B}u) = (-\partial_t (\mc{A}\us) +\mc{B}^\ast\us,u) + W(\us,u) + \left. \int_X \, u \mc{A} \us \right|_\ti^\te 
\ee
and the adjoint operator is:
\be
\O^\ast \us = - \partial_t (\rho C_p \us )  -\div k(u) \grad \us  
\ee
%----------------------
\subsubsection{Coupled nonlinear problem: radiation diffusion and material temperature}
%----------------------

% A ``tad'' more complex. Take a stab at it.

The operators of the forward equation are
\be
\mc{A} = 
\begin{pmatrix}
\frac{1}{c} &  0 \\
0           &   C_v
\end{pmatrix}
\qquad
\mc{B} = 
\begin{pmatrix}
\mc{B}_E      &  \mc{B}_{ET} \\
\mc{B}_{TE}   &  \mc{B}_{T} 
\end{pmatrix}
\ee
with 
\begin{align}
\mc{B}_{E}  &= -\div D_E \grad + \sigma_a \\
\mc{B}_{ET} &= -\sigma_a acT^3 \\
\mc{B}_{T}  &= -\div D_T \grad + \sigma_a acT^3 \\
\mc{B}_{TE} &= -\sigma_a  
\end{align}

The duality expressions are:
\begin{itemize}

\item
\be
(E^\ast, \mc{B}_{E}E) + \langle E^\ast, \mc{L}_E E \rangle = (E, \mc{B}_{E}^\ast E^\ast) + \langle E, \mc{L}_E E^\ast \rangle 
\ee
with $\mc{B}_{E}^\ast = \mc{B}_{E}$ and $\mc{L}_E = n \cdot D_E \grad$.

\item
\be
(T^\ast, \mc{B}_{T}T) + \langle T^\ast, \mc{L}_T T \rangle = (T, \mc{B}_{T}^\ast T^\ast) + \langle T, \mc{L}_T T^\ast \rangle 
\ee
with $\mc{B}_{T}^\ast = \mc{B}_{T}$ and $\mc{L}_T = n \cdot D_T \grad$.

\item
\be
(E^\ast, \mc{B}_{ET}T)  = (T, \mc{B}_{TE}^\ast E^\ast) 
\ee
with $\mc{B}_{TE}^\ast = \mc{B}_{ET}$

\item
\be
(T^\ast, \mc{B}_{TE}E)  = (E, \mc{B}_{ET}^\ast T^\ast) 
\ee
with $\mc{B}_{ET}^\ast = \mc{B}_{TE}$

\end{itemize}

Finally, the adjoint equations are:

\begin{align}
-\frac{1}{c} \partial_t E^\ast - \div D_E(T,E) \grad E^\ast + \sigma_a(T)(E^\ast-T^\ast) &= 0 \\
-C_v \partial_t T^\ast -\div D_T(T) \grad T^\ast +\sigma_a(T)acT^3(T^\ast-E^\ast)            &= 0
\end{align}
(assuming $C_v$ constant)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Sensitivity coefficients}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Let the ``unperturbed'' state be
\begin{align}
\O(u_0,p_0) u_0 &= Q(p_0), \qquad x\in X \\
\mc{C}(u_0,p_0) u_0 &=u_\Gamma(p_0), \qquad x \in \partial X=\Gamma
\end{align}

We consider a perturbation
\be
p = p_0 + \epsilon p_1
\ee
that leads to a perturbation in $u$
\be
u=u_0 + \epsilon u_1 + O(\epsilon ^2)
\ee

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Direct approach}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

A solution consists in directly solving
the perturbed system
\begin{align}
\O(u,p) u &= Q(p), \qquad x\in X \\
\mc{C}(u,p) u &=u_\Gamma(p), \qquad x \in \partial X=\Gamma
\end{align}

and then an expression for the sensitivity coefficient is:
\be
S_p  = \lim_{\epsilon \rightarrow 0^+} \frac{ (\sigma, u_0+\epsilon u_1) - (\sigma, u_0)}{\epsilon} = (\sigma,u_1)
\ee
(assuming $\sigma$ independent of $p$). 

If $\sigma$ is {\bf not} independent of $p$, we have
\be
S_p  = \lim_{\epsilon \rightarrow 0^+} \frac{ (\sigma(p_0) + \epsilon \partial _p \sigma |_{p_0} p_1, u_0+\epsilon u_1) - (\sigma(p_0), u_0)}{\epsilon} = (\sigma,u_1) +  (\partial _p \sigma p_1, u_0)
\ee

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Adjoint magic}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


From the sensitivity coefficient expression, we would like to have an adjoint operator such that
\be
\O^\ast_1 \us = \sigma
\ee
so that
\be
(\sigma,u_1) = (\O_1^\ast \us , u_1 ) =  ( \us , \O_1 u_1 ) - W_1(\us,u_1)   =  ( \us ,rhs_1 ) - W_1(\us,u_1)  
\ee
where $W_1$ will denote the concomitant associated with $\O_1$.\\

What is that special equation for the forward perturbation $u_1$ whose adjoint operator we need?
Note $u_1$ satisfies $\O_1 u_1=rhs_1$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Equation for the perturbation $u_1=D_pu$}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


The equation for the perturbation in $u$, i.e., the $u_1$ unknown, is simply obtained by
taking the difference of the perturbed and unperturbed systems, dividing it by $\epsilon$, and 
letting $\epsilon \rightarrow 0$. This yields:
\begin{align}
\O(u_0,p_0) u_1 + \partial_u\O(u_0,p_0;u_1)u_0 + \partial_p \O(u_0,p_0;p_1) u_0 &= \partial_p Q p_1  \\
\mc{C}(u_0,p_0) u_1 +  \partial_u \mc{C}(u_0,p_0;u_1)u_0 + \partial_p \mc{C}(u_0,p_0;p_1)u_0  &=\partial_p u_\Gamma p_1
\end{align}
%
where the notation $\partial_u\O(u_0,p_0;u_1)$ means that the operator $\partial_u\O$ is evaluated at
$(u_0,p_0)$ and acts on $u_1$. 

We have defined:
\be
\partial_u\O(u_0,p_0;u_1) 
\equiv \lim_{\epsilon \rightarrow 0} \frac{\O(u_0+\epsilon u_1,p_0) - \O(u_0,p_0)}{\epsilon} 
\ee
and
\be
\partial_p\O(u_0,p_0;p_1) 
\equiv \lim_{\epsilon \rightarrow 0} \frac{\O(u_0,p_0+\epsilon p_1) - \O(u_0,p_0)}{\epsilon} 
\ee

%----------------------
\subsubsection{Linear case (linear diffusion)}
%----------------------
TO DO. It's simple.

%----------------------
\subsubsection{Nonlinear case (heat conduction)}
%----------------------
Let us go back to our example to try to clarify a bit. What is $\partial_u\O(u_0,p_0;u_1)u_0$?
From the definition, we have
\begin{align}
\partial_u\O(u_0,p_0;u_1) 
&\equiv \lim_{\epsilon \rightarrow 0} \frac{\O(u_0+\epsilon u_1,p_0) - \O(u_0,p_0)}{\epsilon} \notag \\
&= \lim_{\epsilon \rightarrow 0} \frac{-\div k(u_0+\epsilon u_1,p_0)\grad \cdot +\div k(u_0,p_0)\grad \cdot}{\epsilon} \notag \\
&= -\div \partial_u k(u_0,p_0) u_1\grad \cdot 
\end{align}
So,
\be
\partial_u\O(u_0,p_0;u_1)u_0 =  -\div \left( \partial_u k(u_0,p_0) u_1\grad u_0 \right)
\ee

Next term: What is $\partial_p\O(u_0,p_0;p_1)u_0$?
\begin{align}
\partial_p\O(u_0,p_0;p_1) 
&\equiv \lim_{\epsilon \rightarrow 0} \frac{\O(u_0,p_0+\epsilon p_1) - \O(u_0,p_0)}{\epsilon} \notag \\
&= \lim_{\epsilon \rightarrow 0} \frac{-\div k(u_0,p_0+\epsilon p_1)\grad \cdot +\div k(u_0,p_0)\grad \cdot}{\epsilon} \notag \\
&= -\div \partial_p k(u_0,p_0) p_1\grad \cdot 
\end{align}
So,
\be
\partial_p\O(u_0,p_0;p_1)u_0 =  -\div \left( \partial_p k(u_0,p_0) p_1\grad u_0 \right)
\ee


%----------------------
\subsubsection{Closing on the adjoint magic}
%----------------------

Going back to the general problem and using the $\O_1$ notation to simplify the 
expressions, we have the following {\bf linear} system for $u_1$
\begin{align}
\O_1(u_0,p_0) u_1 &= -\partial_p \O(u_0,p_0;p_1) u_0 +\partial_p Q p_1 \label{eq:pertsystV}\\
\mc{C}_1(u_0,p_0) u_1 &= -\partial_p \mc{C}(u_0,p_0;p_1) u_0 +\partial_p u_\Gamma p_1 \label{eq:pertsystBD}
\end{align}
with
\be
\O_1(u_0,p_0) u_1 \equiv \O(u_0,p_0) u_1 + \partial_u \O(u_0,p_0;u_1)  u_0
\ee
\be
\mc{C}_1(u_0,p_0) u_1 \equiv \mc{C}(u_0,p_0) u_1 + \partial_u \mc{C}(u_0,p_0;u_1)  u_0
\ee

%----------------------
\subsection{Back to the adjoint}
%----------------------

The adjoint equations of \eqt{eq:pertsystV} and \eqt{eq:pertsystBD}  are
%
\begin{align}
\O_1^\ast(u_0,p_0) u^\ast     &= \sigma  \label{eq:adjV} \\ % e_u
\mc{C}^\ast_1(u_0,p_0) u^\ast &= u^\ast_\Gamma \label{eq:adjBD} 
\end{align}
%with $u^\ast_\Gamma(p)$.

Since the $\O_1$ and $\mc{C}_1$ operators are linear, their transpose versions are easy to obtain. 
We also have a duality relation for these operators:
\be
(\us,\O_1(u,p)u) = (\O_1^\ast(u,p)\us,u) + W_1(\us,u)
\ee
Note, the concomitant is denoted by $W_1$ and $W_1 \ne W$.

The sensitivity coefficient is 
%
\begin{align}
S_p &= (\sigma, u_1) \notag \\
&= (\O_1^\ast(u_0,p_0) \us, u_1)  \notag \\
&= ( \us, \O_1(u_0,p_0) u_1) -W_1(\us,u_1) \notag \\
&= ( \us, -\partial_p \O(u_0,p_0;p_1) u_0 +\partial_p Q p_1) -W_1(\us,u_1) 
\end{align}

With our heat conduction example, we have
\be
S_p = \left( \us,  -\div \left( \partial_p k(u_0,p_0) p_1\grad u_0 \right) +\partial_p Q p_1 \right) -W_1(\us,u_1) 
\label{eq:dotprod}
\ee

Evaluating $S_p$ requires, therefore,
\ben
\item
computing $\us$ from \eqt{eq:adjV}  and \eqt{eq:adjBD} 
\item
evaluating scalar products in \eqt{eq:dotprod}
\item
what about $u_1$ at the boundary? (it is used in $W_1$ but it is 
also part of the specifications of the problem, so it must be known!)
\item
practically, $p_1$ is user-specified.
\een

%\begin{align}
%S_p = D_p\mc{F}[u_0,p_0;u_1,p_1] &= \lim_{\epsilon \rightarrow 0^+} \frac{\mc{F}[u+\epsilon u_1,p_0+\epsilon p_1] - \mc{F}[u_0,p_0] }{\epsilon} \notag \\
%&= \partial_u \mc{F}[u_0,p_0;u_1] + \partial_p \mc{F}[u_0,p_0;p_1] 
%\end{align}
%$\partial_u \mc{F}[u_0,p_0;u_1]$ acts on $u_1$ and is evaluated at $u_0,p_0$.\\
%$\partial_p \mc{F}[u_0,p_0;p_1]$ acts on $p_1$ and is evaluated at $u_0,p_0$.
%
%By definition of $\mc{F}$, we have
%\begin{align}
%S_p = (\B^\ast(u,p)\us, u) &= \left(\us,D_p(\B(u,p)u)\right) - W(\us,u_1) \notag\\
%&= \left(\us,D_p \B(u,p)u_0\right) + \left(\us,\B(u_0,p_0)u_1\right) - W(\us,u_1) \notag\\
%&= \left(\us,(\partial_u \B(u,p))u_0\right) + \left(\us,(\partial_p \B(u,p))u_0\right) + \left(\us,\B(u_0,p_0)u_1\right) - W(\us,u_1) \notag\\
%\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Radiation diffusion with material temperature}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{align}
\O_1(u_0,p_0) u_1 & \equiv \O(u_0,p_0) u_1 + \partial_u \O(u_0,p_0;u_1)  u_0 \notag \\
                  & =(\mc{A}\partial_t + \mc{B}) u_1 + \partial_u \mc{A}(u_0,p_0;u_1)  \partial_t u_0 + \partial_u \mc{B}(u_0,p_0;u_1)  u_0
\end{align}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%------------------------------------------------------
\end{document}
